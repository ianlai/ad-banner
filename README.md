# Ad Banner

## 1. Project Intro: 

#### (1) Basic:
This is an ad banner service implemented in Node.js without web framework like Express.  
- Frontend: `html` + `JavaScript` + `jQuery`
- Backend: `Node.js` + `Mongo DB (mongoose)`
- Test: `Jasmine`

#### (2) Features: 

- Ad-platform (run this service): 
	1. Provides the main page to the end-user with an ad banner. 
	2. Provides the admin page to the ad-publisher to post an ad. 
	3. Provides the API server.  
- Ad-publisher: 
	1. Add a new ad with admin page or with the POST api. 
  	2. Assign the promotional time to show the ad. 
  	3. Assign the management IP to check the ad even when being out of the promotional time.
- End-User: 
	1. Access the main page and randomly see an ad which is in its promotional time based on the request time and the timezone of the end-user.

#### (3) Temporary test url:
This temporary server is hosted in c9 service. You can test the main page and the admin page with the following URLs. However, there is no guarantee how long it can runs without problem.
- Page: Main
	- https://webdevbootcamp-ianlai.c9users.io/
- Page: Admin
	- https://webdevbootcamp-ianlai.c9users.io/admin
- API: Retrieving the whole ad list
    - https://webdevbootcamp-ianlai.c9users.io/api/v1/ads/

## 2. Data Format: 

The example of data are shown as follows. 

##### Ad schema (used in database and response): 
    Ad = { 
        img         : "/sample1.png",        # ad img
        url         : "www.ad.com/1",        # ad link
        ip          : "1.1.1.1",             # management IP
        timeStart   : 1523963781963,         # display time start
        timeDuration: 1000000,               # display time period
        identifier  : "ad1"                  # for debugging (app-layer id)
    }

##### Ad request format:
    AdRequest = { 
        id          : '5adc1cc9cc60d16845415d00',
        method      : 'GET',
        url         : '/5adc1cc9cc60d16845415d00',
        ip          : '1.1.1.1',
        date        : '20180422',
        time        : 1524375740961,
        timezone    : '-540' 
    }
The id is generated by Mongo DB. The IP is extracted from the http connection, and the current date and time are recorded when the request arrives the server. Therefore, only `method`, `url`, `timezone` are adjustable by an end-user. 

## 3. Endpoint:

#### (1) HTML 
- **GET /** 
  - Main page for end-user to request the content with an ad banner inside. 

- **GET /admin** 
  - Admin page for ad-publisher to post an ad. 

#### (2) API 
- **GET /api/v1/ads**
  - Reply all the ads in the database. 

- **GET /api/v1/ads?tz=[time-zone-offset]**
  - For end-user to request an ad. It will response the feasible ad based on the request time and the end-user's timezone.
  - time-zone-offset: offset to UTC in minutes (ex. JST: -540) 

- **GET /api/v1/ads/[:id]**  
  - For the ad-publisher to show a specific ad with the id. This ignores the promotional time limitation, but the request needs to come from a valid IP address bundled with the ad. 
 
- **POST /api/v1/ads**
  - For ad-publisher to post an ad. The format needs to match the ad format. 

## 4. Files, Functions, Tests:
The files are list as follows (excluding `.git` and `node_modules` folders)

#### (1) File Structure
```
├── README.md
├── apiHandler.js
├── dbHandler.js
├── package.json
├── public
│   ├── admin.html
│   ├── admin.js
│   ├── index.html
│   └── index.js
├── server.js
└── spec
    ├── api-spec.js
    └── support
        └── jasmine.json
```
#### (2) File description

##### [a. Root folder | server side codes]
- *server.js*
	- Main js file for the server side. It receives the requests from the clients and handles the routing including static html and api. 
- *apiHandler.js*
	- An API handler interacting with database and exposing a `getAd` function which returns an ad list according to the ad request.
	- If the ad request is 0, `getAd` function returns a full ad list from the database. 
	- If the ad request has an id, it checks whether the IP of the request matches the IP assigned to the ad. It they are matched, `getAd` function returns the requested ad. 
	- If the ad request doesn't have an id, it randomly return an ad which matches the promotional time and timezone requirement. 
		- Each ad has `timeStart` and `timeDuration` field which represents the period to show the ad. This time is recorded as UTC timezone. When a request comes, server will ask the client to send its timezone, and then server uses the timezone info to convert the request time to UTC timezone and determine which ad can be shown.
- *dbHandler.js*
	- A database handler exposing the database's model meanwhile providing two functions mainly for development use (`clearDatabase`, `seedDatabase`).  

##### [b. Public folder | client side codes]
There are two html pages. One is for letting end-user to get an ad, and the other one is for letting ad-publisher to post an ad. 

- *index.html*
	- Main page for the end-user. It has two blocks. One block shows the main content, and the other one shows the ad as the ad banner. 
- *index.js* 
	- This javascript is loaded by index.html and it sends a "Ajax GET" back to server to acquire the ad. It also sends the timezone information via parameter to help the server determine the valid ads.  
- *admin.html*
	- Admin page for the ad-publisher to add an ad. 
- *admin.js*
	- This javascript is loaded by admin.html and it sends a "Ajax POST" to server to add an ad. 
    
##### [c. spec folder: test codes]
The test codes are based on Jasmine BDD framework. 
- *jasmine.json*
	- The file is generated by Jasmine by default. It describes the files (specs) to run the test.
- *api-spec.js*
	- This file has 4 test cases for testing the API (apiHandler). Type `jasmine` in the root folder to start the test.
	1. Get the whole ad list
	2. Get a random ad
	3. Get an ad with specified id (if the IP matches)
	4. Get an ad with specified id (if the IP does not match)
  

## 5. Release Notes: 

**2018.04.22**
- Separate the endpoints to be two groups: HTML and APIs
- Admin page can post a new ad

**2018.04.21**
- Separate the pages to two: index.html(end-user) and admin.html(ad-publisher)
- Refactor: separate server.js, apiHandler.js, dbHandler.js
- Test code with Jasmine (apiHandler) 

**2018.04.20**
- Add a POST route for adding a new add
- Store the ads into Mongo DB instead of a temporary array
- Add clear and seed functions for initializing the DB
- Randomly choose one valid ad to return instead of sending all feasible ads back 

**2018.04.18**
- Server side filter ads to send back according to the promotional time
- Client side shows the ad (its `img` and `url`) 
- Server side send back a specific ad for ad-publisher (request with ID and correct IP)
- Server side can send all ads back

**2018.04.17** 
- Server side get request time and IP from client (1st request)
- Server side get time zone from params (2nd request)